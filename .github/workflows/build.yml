# GitHub Actions Workflow for Video Captioner
# macOS build only (optimized for size)

name: Build Application

on:
  # Trigger on version tags
  push:
    tags:
      - 'v*'
  
  # Allow manual trigger
  workflow_dispatch:
    inputs:
      build_type:
        description: 'Build type'
        required: true
        default: 'release'
        type: choice
        options:
          - release
          - debug

env:
  PYTHON_VERSION: '3.11'

jobs:
  # ========================================
  # MACOS BUILD
  # ========================================
  build-macos:
    name: Build macOS
    runs-on: macos-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}
          cache: 'pip'

      - name: Install system dependencies
        run: |
          brew install ffmpeg

      - name: Install Python dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt
          pip install pyinstaller

      - name: Install PyTorch 2.8.0 (macOS)
        run: |
          pip uninstall -y torch torchvision torchaudio
          pip install torch==2.8.0 torchvision==0.23.0 torchaudio==2.8.0

      - name: Build with PyInstaller
        run: |
          python -m PyInstaller captioner_compact.spec --clean --noconfirm

      - name: List build output
        run: |
          echo "Build output:"
          if [ -d "dist/VideoCaptioner.app" ]; then
            du -sh dist/VideoCaptioner.app
            ls -lh dist/VideoCaptioner.app/Contents/MacOS/
          fi

      - name: Create release package
        run: |
          mkdir -p release-macos
          
          if [ -d "dist/VideoCaptioner.app" ]; then
            # Copy the entire app bundle
            cp -R dist/VideoCaptioner.app release-macos/
            
            # Create README
            cat > release-macos/README.txt << 'EOF'
          Video Captioner - macOS (Optimized Build)
          ==========================================
          
          REQUIREMENTS:
          - macOS 10.15 (Catalina) or later
          - Apple Silicon (M1/M2/M3) or Intel Mac
          - 4GB RAM minimum (8GB recommended)
          - FFmpeg (bundled)
          
          BUILD SIZE: ~400-450MB (CUDA libraries excluded)
          GPU ACCELERATION: Uses MPS (Metal Performance Shaders) on Apple Silicon
          
          INSTALLATION:
          1. Extract the ZIP file
          2. Drag VideoCaptioner.app to your Applications folder
          3. First launch: Right-click the app and select "Open"
             (This bypasses Gatekeeper for unsigned apps)
          4. Click "Open" in the security dialog
          
          MACOS SECURITY NOTE:
          This app is not signed with an Apple Developer certificate.
          On first launch, macOS will show a security warning.
          
          To open the app:
          - Method 1: Right-click → Open → Click "Open" in dialog
          - Method 2: System Settings → Privacy & Security → 
                      Click "Open Anyway" for VideoCaptioner
          
          FEATURES:
          - Native macOS app bundle
          - Optimized for both Apple Silicon and Intel
          - GPU acceleration via Metal on Apple Silicon
          - Supports all Whisper models (tiny to large-v3)
          - Batch processing
          - VTT/SRT subtitle generation
          - Vocabulary correction with CSV support
          - Context prompts for improved accuracy
          
          PERFORMANCE:
          - Apple Silicon (M1/M2/M3): Excellent GPU performance using MPS
          - Intel Mac: Good CPU performance
          
          For more information: https://github.com/sarahapplebaum/NewCaptionApp
          EOF
          fi

      - name: Upload macOS artifact
        uses: actions/upload-artifact@v4
        with:
          name: VideoCaptioner-macOS
          path: release-macos/
          retention-days: 90

  # ========================================
  # CREATE RELEASE (if triggered by tag)
  # ========================================
  create-release:
    name: Create GitHub Release
    needs: [build-macos]
    runs-on: ubuntu-latest
    if: startsWith(github.ref, 'refs/tags/')
    
    steps:
      - name: Download all artifacts
        uses: actions/download-artifact@v4
        with:
          path: artifacts

      - name: Create ZIP archive
        run: |
          cd artifacts
          
          # macOS - create ZIP
          if [ -d "VideoCaptioner-macOS" ]; then
            cd VideoCaptioner-macOS
            zip -r ../VideoCaptioner-macOS.zip .
            cd ..
          fi

      - name: Create Release
        uses: softprops/action-gh-release@v1
        with:
          files: |
            artifacts/VideoCaptioner-macOS.zip
          draft: false
          prerelease: false
          generate_release_notes: true
          body: |
            ## Video Captioner Release - macOS
            
            ### Download
            
            **macOS Users:**
            - `VideoCaptioner-macOS.zip` (~400-450MB)
            
            ### Optimizations
            
            This build has been optimized for size:
            - CUDA libraries excluded (not needed on macOS)
            - GPU acceleration via Metal Performance Shaders (MPS)
            - ~250-300MB smaller than previous builds
            - Full functionality preserved
            
            ### Requirements
            
            - macOS 10.15 (Catalina) or later
            - Works on both Apple Silicon and Intel Macs
            - 4GB RAM minimum (8GB recommended)
            
            ### Features
            
            - Multiple Whisper AI models (tiny to large-v3)
            - GPU acceleration on Apple Silicon (via MPS)
            - Batch video processing
            - VTT and SRT subtitle generation
            - Vocabulary correction for technical terms
            - Context prompts for improved accuracy
            - FFmpeg bundled (no separate installation needed)
            
            ### Installation
            
            1. Download the ZIP file
            2. Extract it
            3. Drag VideoCaptioner.app to your Applications folder
            4. First launch: Right-click the app and select "Open"
               (This bypasses Gatekeeper for unsigned apps)
            5. Click "Open" in the security dialog
            
            For detailed information, see the README.txt file included in the package.
            
            ### Windows Users
            
            Windows builds are currently disabled in CI/CD. To run on Windows:
            1. Clone the repository
            2. Run `START_HERE.bat` for automated setup
            3. Or use `python captioner_compact.py` after installing requirements
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
